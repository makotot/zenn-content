---
title: "jestã«ãŠã‘ã‚‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³æ•°ã®åˆ¶é™ã«ã¤ã„ã¦"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["jest", "eslint", "test"]
published: true
---

## `jest/max-expects`

[`eslint-plugin-jest`](https://github.com/jest-community/eslint-plugin-jest/)ã«ã€ãƒ†ã‚¹ãƒˆæ¯ã«[`expect`](https://jestjs.io/ja/docs/expect#expectvalue)ã®å›æ•°ã‚’åˆ¶é™ã™ã‚‹[`max-expects`](https://github.com/jest-community/eslint-plugin-jest/blob/main/docs/rules/max-expects.md)ã®ãƒ«ãƒ¼ãƒ«ã‚’ææ¡ˆã—ã¦ã€Pull Requestã‚’å‡ºã—ã¦ã€v26.6.0ã§ãƒªãƒªãƒ¼ã‚¹ã—ã¦ã‚‚ã‚‰ã£ãŸã€‚

https://github.com/jest-community/eslint-plugin-jest/releases/tag/v26.6.0

ãªã®ã§`eslint-plugin-jest`ã®v26.6.0ã‹ã‚‰`jest/max-expects`ã‚’`rules`ã«è¿½åŠ ã™ã‚‹ã¨

```diff:.eslintrc.json
{
  ...,
  "rules": {
      ...,
+    "jest/max-expects": ["error", { "max": 2 }]
  }
}
```

`test`ã®ä¸­ã§`max`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ä¸Šé™å€¤ã‚’è¶…ãˆã¦`expect`ã‚’ä½¿ã£ã¦ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã„ã‚‹ç®‡æ‰€ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«[ESLint](https://eslint.org/)ãŒã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Šã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

```sh
Too many assertion calls (3). Maximum allowed is 2.
```

`max`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯`5`ã§ã€ã“ã‚Œã¯[`ava/max-asserts`](https://github.com/avajs/eslint-plugin-ava/blob/main/docs/rules/max-asserts.md#options)ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å‚è€ƒã«ã—ã¦ã„ã‚‹ã€‚

æ¤œçŸ¥ã§ãã‚‹ç¯„å›²ã¨ã—ã¦ã‚ãã¾ã§ASTè§£æã—ã¦è¦‹åˆ†ã‘ã‚‰ã‚Œã‚‹ã‚‚ã®ãŒå¯¾è±¡ã ã¨æ€ã†ã®ã§ã€`for`æ–‡ã®ã‚ˆã†ãªå½¢ã§ç¹°ã‚Šè¿”ã—`expect`ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã¾ã§ã¯ã‚«ãƒãƒ¼ã§ããªã„èªè­˜ï¼ˆ[`prefer-each`](https://github.com/jest-community/eslint-plugin-jest/issues/1048)ã®ãƒ«ãƒ¼ãƒ«ãŒè¿½åŠ ã•ã‚Œã‚‹ã¨ã€ãã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒ«ã®çµ„ã¿åˆã‚ã›ã§çµæœçš„ã«é˜²ã’ã‚‹ã‚ˆã†ã«ãªã‚‹ã‹ã‚‚ï¼Ÿï¼‰ã€‚

## ãƒ†ã‚¹ãƒˆã«ãŠã‘ã‚‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã®æ•°ã«ã¤ã„ã¦

ä¸Šè¿°ã®ESLintã®ãƒ«ãƒ¼ãƒ«ã¯ã€[jest](https://jestjs.io/)ã®ãƒ†ã‚¹ãƒˆã«ãŠã‘ã‚‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³æ•°ã‚’åˆ¶é™ã™ã‚‹ã‚‚ã®ã ã‘ã©ã€ãã‚‚ãã‚‚ãƒ†ã‚¹ãƒˆã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³æ•°ãŒå°‘ãªã„ã“ã¨ã‚’æœ›ã¾ã—ã„ã¨ã™ã‚‹èƒŒæ™¯ã¯ä½•ã‹ã€‚

### Assertion Roulette

[XUnit Test Patterns](http://xunitpatterns.com/)ã§ã¯ã€`Behavior Smells`ï¼ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã®è‡­ã„ï¼‰ã®ã‚«ãƒ†ã‚´ãƒªã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹[`Assertion Roulette`](http://xunitpatterns.com/Assertion%20Roulette.html)ãŒã‚ã‚‹ã€‚
ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ãŒå¤±æ•—ã‚’å‡ºåŠ›ã—ã¦ã‚‚ã€ã©ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã§å¤±æ•—ã—ãŸã‹ã‚’ç‰¹å®šã§ããªã„ã‚ˆã†ãªçŠ¶æ³ã‚’ã•ã—ã¦ã„ã‚‹ã€‚

> A test fails. Upon examining the output of the Test Runner (page X), we cannot determine exactly which assertion had failed.
>
> http://xunitpatterns.com/Assertion%20Roulette.html

æ˜ç¢ºã«ãã‚Œãã‚Œã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³æ¯ã«ãƒ†ã‚¹ãƒˆã‚’åˆ†ã‘ãŸæ–¹ãŒå¤±æ•—ã—ãŸæ™‚ã«åŸå› ã®åˆ‡ã‚Šåˆ†ã‘ãŒã—ã‚„ã™ã„ã¨ã„ã†ã“ã¨ãŒã‚ã‚‹ã€‚
ã¾ãŸã€å¤±æ•—ã—ãŸã‚ã¨ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’éš ã—ã¦ã—ã¾ã†å•é¡ŒãŒã‚ã‚‹ã€‚
ä¾‹ãˆã°ã€1ã¤ã®ãƒ†ã‚¹ãƒˆã§3å›`expect`ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆã«ã€2ã¤ç›®ã®`expect`ã§å¤±æ•—ã™ã‚‹ã¨3ã¤ç›®ã®`expect`ã¯ãƒ†ã‚¹ãƒˆçµæœãŒåˆ†ã‹ã‚‰ãªã„ï¼ˆãã†ã˜ã‚ƒãªã„ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚‚ã‚ã‚‹ã®ã‹ã‚‚ã—ã‚Œãªã„ï¼Ÿï¼‰ã®ã§ã€å¤±æ•—ã‹ã‚‚ã—ã‚Œãªã„ã—ãã†ã˜ã‚ƒãªã„ã‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚

> ä¸€èˆ¬çš„ãªãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã¯ã€ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã«ä¾‹å¤–ãŒç™ºç”Ÿã—ã€ãã®ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè¡Œã¯æ‰“ã¡åˆ‡ã‚‰ã‚Œã¾ã™ã€‚
>
> https://t-wada.hatenablog.jp/entry/design-for-testability

1ã¤ã®ãƒ†ã‚¹ãƒˆã«1ã¤ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãŒç†æƒ³çš„ã¨ã„ã†è€ƒãˆæ–¹ãŒã‚ã‚‹ã€‚ãŸã ã€ã‚ãã¾ã§ç†æƒ³çš„ã«ã¯ã¨ã„ã†ã“ã¨ã§ã‚ã£ã¦ã€1ã¤ã®ãƒ†ã‚¹ãƒˆã«å¿…ãšã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’1ã¤ã¨ã™ã‚‹ã®ã§ã¯ãªãè«–ç†çš„ãªã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’1ã¤ã¨ã™ã‚‹ãã‚‰ã„ã§è€ƒãˆã‚‹ã¹ãã‹ã‚‚ã—ã‚Œãªã„ã€‚

> My guideline is usually that you test one logical CONCEPT per test. you can have multiple asserts on the same object. they will usually be the same concept being tested.
>
> https://softwareengineering.stackexchange.com/questions/7823/is-it-ok-to-have-multiple-asserts-in-a-single-unit-test

## å‚è€ƒè³‡æ–™

- [Better Specs. Testing Guidelines for Developers.](https://www.betterspecs.org/#single)
- [Good unit test - One Assert | Michal Franc](https://mfranc.com/unit-testing/good-unit-test-one-assert/)
