---
title: "Storybookã®ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼"
emoji: "ğŸ•Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['storybook', 'test']
published: true
---

## ã¯ã˜ã‚ã«

> Storybook test runner turns all of your stories into executable tests.
> https://github.com/storybookjs/test-runner

[Storybook](https://storybook.js.org/)ã®å…¨ã¦ã®Storyã‚’ãƒ†ã‚¹ãƒˆå¯èƒ½ã«ã™ã‚‹`@storybook/test-runner`ã«ã¤ã„ã¦ã®ãƒ¡ãƒ¢ã€‚
Storybookã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯v6.5ã‹ã‚‰[ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã«ã¤ã„ã¦](https://storybook.js.org/docs/react/writing-tests/test-runner)ã«ã¤ã„ã¦ã®ãƒšãƒ¼ã‚¸ãŒè¨­ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã€‚

## ä½•ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚‚ã®ã‹

ãƒ†ã‚¹ãƒˆå¯¾è±¡ã«ã¤ã„ã¦ã¯[`play`é–¢æ•°](https://storybook.js.org/docs/react/writing-stories/play-function)ã®æœ‰ç„¡ã«ã‚ˆã£ã¦ç•°ãªã‚‹ã€‚

> - For those without a play function: it verifies whether the story renders without any errors.
> - For those with a play function: it also checks for errors in the play function and that all assertions passed.
>
> https://storybook.js.org/docs/react/writing-tests/test-runner

`@storybook/test-runner`ãŒãƒ†ã‚¹ãƒˆã™ã‚‹ã®ã¯ã€`play`é–¢æ•°ã‚’æŒãŸãªã„Storyã§ã‚ã‚Œã°StoryãŒã‚¨ãƒ©ãƒ¼ãªããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã€`play`é–¢æ•°ã‚’æŒã¤Storyã®å ´åˆã¯ãã®StoryãŒã‚¨ãƒ©ãƒ¼ãªããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã«åŠ ãˆã¦`play`é–¢æ•°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã¨ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ã®ã‚ˆã†ã€‚

|            | ã‚¨ãƒ©ãƒ¼ãªãStoryãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ | `play`é–¢æ•°ã‚’ã‚¨ãƒ©ãƒ¼ãªãå®Ÿè¡Œã§ãã‚‹ | `play`é–¢æ•°ã§ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¨ã¦ãƒ‘ã‚¹ã™ã‚‹ |
| ---------- | -------------------- | ------------------- | ----------------------- |
| `play`é–¢æ•°ãªã— | â—‹                    | -                   | -                       |
| `play`é–¢æ•°ã‚ã‚Š | â—‹                    | â—‹                   | â—‹                       |

Storybookã§å…¨ã¦ã®Storyã‚’éƒ½åº¦ç¢ºèªã™ã‚‹ã®ã¯éå¸¸ã«æ‰‹é–“ãŒã‹ã‹ã‚‹ã—äº‹ç´°ã‹ã«ç¢ºèªã™ã‚‹ã“ã¨ã¯ç¾å®Ÿçš„ã§ã¯ãªã„ã®ã§ã€`@storybook/test-runner`ã«ã‚ˆã£ã¦å…¨ã¦ã®StoryãŒæ­£å¸¸ã«è¡¨ç¤ºã§ãã¦ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚‚æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã§è‚©ä»£ã‚ã‚Šã™ã‚‹ã€‚

ã¾ãŸã€ãƒ†ã‚¹ãƒˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ãŸç’°å¢ƒã§ã¯ãªãã€ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§Storybookã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã‚‚ã®ã®ã‚ˆã†ã§å†…éƒ¨çš„ã«ã¯[jest](https://jestjs.io/) + [playwright](https://playwright.dev/)ã‚’åˆ©ç”¨ã—ã¦å®Ÿç¾ã•ã‚Œã¦ã„ã‚‹ãã†ã€‚


## è©¦ã—ã¦ã¿ã‚‹

å®Ÿéš›ã«`@storybook/test-runner`ã‚’è©¦ã—ã¦ã¿ã‚‹ã€‚
https://github.com/makotot/sb-test-runner-playground ãŒãã®ãƒªãƒã‚¸ãƒˆãƒªã€‚

### äº‹å‰æº–å‚™

ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’viteã§ç”¨æ„ã—ã¦ãŠãã€‚

```sh
$ npm create vite@latest

âœ” Project name: â€¦ sb-test-runner-playground
âœ” Select a framework: â€º react
âœ” Select a variant: â€º react-ts

Scaffolding project in /path/to/sb-test-runner-playground...

Done. Now run:

  cd sb-test-runner-playground
  npm install
  npm run dev
```

ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Storybookã‚’ç”¨æ„ã™ã‚‹ã€‚

```sh
$ cd sb-test-runner-playground
$ npx sb init --builder @storybook/builder-vite

Need to install the following packages:
  sb
Ok to proceed? (y) y

 storybook init - the simplest way to add a Storybook to your project.

 â€¢ Detecting project type. âœ“
 â€¢ Adding Storybook support to your "React" app

attention => Storybook now collects completely anonymous telemetry regarding usage.
This information is used to shape Storybook's roadmap and prioritize features.
You can learn more, including how to opt-out if you'd not like to participate in this anonymous program, by visiting the following URL:
https://storybook.js.org/telemetry

.
.
.

. âœ“
ğŸ” checking possible migrations..

âœ… migration check successfully ran

To run your Storybook, type:

   npm run storybook

For more information visit: https://storybook.js.org
```

`npm run storybook`ã§StorybookãŒèµ·å‹•ã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚

## `@storybook/test-runner`ã‚’å®Ÿè¡Œã™ã‚‹

Storybookã®ç’°å¢ƒãŒç”¨æ„ã§ããŸã®ã§ã€`@storybook/test-runner`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚`peerDependencies`ã§ã‚ã‚‹jestã‚‚åŒæ™‚ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```sh
$ npm i -E -D @storybook/test-runner jest
```

`npm run test-storybook`ã§ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«`scripts`ã‚’è¿½åŠ ã—ã¦ãŠãã€‚ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã‚‚åˆ©ç”¨ã™ã‚‹ã®ã§`--watch`ã‚’åˆ©ç”¨ã—ãŸ`scripts`ã‚’è¿½åŠ ã—ã¦ãŠãã€‚

```json:package.json
"scripts": {
  ...,
  "test-storybook": "test-storybook",
  "test-storybook:watch": "test-storybook --watch"
}
```

ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã¯Storybookã«å¯¾ã—ã¦å®Ÿè¡Œã™ã‚‹ã®ã§ã€storybookã‚’èµ·å‹•ã™ã‚‹ã€‚

```sh
$ npm run storybook
```

#### jest v28

`@storybook/test-runner`ã®v0.1.0ã‚’åˆ©ç”¨ã—ã¦ç¢ºèªã—ã¦ã„ã‚‹ãŒã€`npm run test-storybook`ã‚’å®Ÿè¡Œã™ã‚‹ã¨jestã«é–¢ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚

:::message
@storybook/test-runner v0.1.0ã§ç¢ºèªã—ãŸã‚‚ã®ã€‚
jest-playwrightãŒäº’æ›æ€§ã®å•é¡Œã‚’è§£æ¶ˆã™ã‚‹ã¾ã§ã¯jest v27ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’ä»Šã¯READMEã«æ˜è¨˜ã—ã¦ã„ã‚‹ã—ã€å®Ÿè¡Œæ™‚ã«è­¦å‘Šã‚’å‡ºã™ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¯ãšã€‚
https://github.com/storybookjs/test-runner/pull/111
:::

```sh
$ npm run test-storybook

> sb-test-runner-playground@0.0.0 test-storybook
> test-storybook

TypeError: Jest: Got error running globalSetup - /path/to/sb-test-runner-playground/node_modules/@storybook/test-runner/playwright/global-setup.js, reason: Class extends value #<Object> is not a constructor or null
```

ã“ã‚Œã¯jest-playwrightã®äº’æ›æ€§ã®å•é¡Œã§jest v28ã«ã¯å¯¾å¿œã§ãã¦ãªã„ã®ã§v27ã«å¼·åˆ¶çš„ã«ç•™ã‚ã¦ãŠãå¯¾å¿œã‚’è¡Œã†ã¨å›é¿ã§ãã‚‹ã€‚

https://github.com/storybookjs/test-runner/issues/99

`node_modules/`ã®ä¸­ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã¨v28ã§å…¥ã£ã¦ã„ã‚‹jesté–¢é€£ã®npmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚ï¼ˆ`$ npm ls`ã§ã‚ˆã‹ã£ãŸã‹ã‚‚ã—ã‚Œãªã„ã€‚ï¼‰

```sh
$ cat node_modules/jest/package.json | grep version
  "version": "27.5.1",

$ cat node_modules/jest-runner/package.json | grep version
  "version": "28.1.0",

$ cat node_modules/jest-environment-node/package.json | grep version
  "version": "28.1.0",
```

v28ã«ãªã£ã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«é–¢ã—ã¦ã¯å€‹åˆ¥ã«v27ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```sh
$ npm i -E -D jest-runner@27.5.1 jest-environment-node@27.5.1
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸv27ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å›ºå®šã—ã¦ãŠãã€‚ã€€

```json:package.json
"resolutions": {
  "jest": "27.5.1",
  "jest-runner": "27.5.1",
  "jest-environment-node": "27.5.1"
}
```

v27ã«å›ºå®šã—ã¦å†åº¦å®Ÿè¡Œã™ã‚‹ã¨ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ãŒå•é¡Œãªãå‹•ãã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚

```sh
$ npm run test-storybook

> sb-test-runner-playground@0.0.0 test-storybook
> test-storybook

 PASS   browser: chromium  src/stories/Header.stories.tsx
 PASS   browser: chromium  src/stories/Button.stories.tsx
 PASS   browser: chromium  src/stories/Page.stories.tsx

Test Suites: 3 passed, 3 total
Tests:       8 passed, 8 total
Snapshots:   0 total
Time:        11.402 s
Ran all test suites.
```

#### ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ‡ãƒãƒƒã‚°ã®è¨­å®š

ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ‡ãƒãƒƒã‚°ã‚’å¯èƒ½ã«ã—ã¦ãŠããŸã‚ã€`@storybook/jest`ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã€‚[`@storybook/addon-interactions`](https://storybook.js.org/addons/@storybook/addon-interactions)ã‚„`@storybook/testing-library`ã‚‚å¿…è¦ã¨ãªã‚‹ã‘ã©ã€ã“ã‚Œã‚‰ã¯ã™ã§ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã¯ãšã€‚

```sh
$ npm i -E -D @storybook/jest
```

`.storybook/main.js`ã®`features`ã«`interactionsDebugger`ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‚ˆã†ã«è¿½è¨˜ã™ã‚‹ã€‚

```diff:main.js
  features: {
    storyStoreV7: true,
+    interactionsDebugger: true,
  },
```

### ãƒ†ã‚¹ãƒˆã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ãªãŒã‚‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–‹ç™ºã™ã‚‹

äº‹å‰æº–å‚™ãŒå®Œäº†ã—ãŸã®ã§ã€ã“ã“ã‹ã‚‰æœ¬é¡Œã®ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã§ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã€‚ã¾ãšã¯ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨ãªã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ãã®Storyã‚’ç”¨æ„ã™ã‚‹ã€‚

çŠ¶æ³ã¨ã—ã¦ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦`Button`ã¨ãã®`Button`ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«1ãšã¤æ•°å€¤ã‚’å¢—æ¸›ã•ã›ã‚‹`Counter`ã‚’Storyã¨ã—ã¦æŒã£ã¦ã„ã‚‹StorybookãŒã‚ã‚‹ã¨ã„ã†çŠ¶æ³ä¸‹ã«ã‚ã‚‹ã¨ä»®å®šã™ã‚‹ã€‚

ã¾ãŸã€ã“ã“ã§ã¯ãã®`Button`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’StorybookãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”¨æ„ã—ã¦ã„ã‚‹`stories/Button.tsx`ã¨ã™ã‚‹ã€‚ä»¥ä¸‹URLã®ã‚‚ã®ã¨åŒã˜ã¯ãšã€‚

https://github.com/storybookjs/storybook/blob/e9fad373219789488ccae5c423022c7096bd5e06/lib/cli/src/frameworks/react/ts/Button.tsx

ãã®ä¸Šã§ã€`Counter`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§ç”¨æ„ã™ã‚‹ã€‚

```tsx
import * as React from 'react'
import { Button } from './Button'

export const Counter: React.FC<{ initialValue: number }> = ({
  initialValue = 0,
}) => {
  const [value, updateValue] = React.useState(initialValue)
  const increment = () => {
    updateValue((prev) => prev + 1)
  }
  const decrement = () => {
    updateValue((prev) => prev + -1)
  }

  return (
    <div
      style={{
        display: 'flex',
        gap: '1rem',
        alignItems: 'center',
      }}>
      <Button data-testid="increment" label="+1" onClick={increment} />
      <div data-testid="counter-value">{value}</div>
      <Button data-testid="decrement" label="-1" onClick={decrement} />
    </div>
  )
}
```

Storybookä¸Šã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/874959040844-20220529.png)

`Counter`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®Storyãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦`Counter.stories.tsx`ã‚‚ç”¨æ„ã—ã¦ã€`play`é–¢æ•°ã‚’`+1`ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ãŸã‚‰0ã ã£ãŸã‚«ã‚¦ãƒ³ã‚¿è¡¨ç¤ºãŒ1ã«å¤‰ã‚ã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆã«åˆ©ç”¨ã™ã‚‹ã€‚

```tsx
import * as React from 'react'
import { ComponentStory, ComponentMeta } from '@storybook/react'
import { userEvent, within } from '@storybook/testing-library'
import { expect } from '@storybook/jest'
import { Counter } from './Counter'

export default {
  title: 'Counter',
  component: Counter,
  argTypes: {},
  args: {
    initialValue: 0,
  },
} as ComponentMeta<typeof Counter>

const Template: ComponentStory<typeof Counter> = (args) => <Counter {...args} />

export const Default = Template.bind({})
Default.play = async ({ canvasElement }) => {
  const canvas = within(canvasElement)
  const value = canvas.getByTestId('counter-value')
  expect(value.innerText).toEqual('0')
  await userEvent.click(canvas.getByTestId('increment'))
  expect(value.innerText).toEqual('1')
}
```

ã“ã®`play`é–¢æ•°ã®ãƒ†ã‚¹ãƒˆçµæœã¯`@storybook/addon-interactions`ã®ã‚¢ãƒ‰ã‚ªãƒ³ã®`Interactions`ã®ãƒ‘ãƒãƒ«ã§ç¢ºèªã§ãã¦ã€ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/97570ddf8b40-20220529.png)

`@storybook/test-runner`ã‚’ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¦ã¿ã‚‹ã¨åŒã˜ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆã¯æˆåŠŸã™ã‚‹ã€‚ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚’çµã£ã¦ãªã„ã®ã§å®Ÿè¡Œæ™‚é–“ã¯è‹¥å¹²ã‹ã‹ã‚‹ã€‚

```sh
$ npm run test-storybook:watch
 PASS   browser: chromium  src/stories/Header.stories.tsx
 PASS   browser: chromium  src/stories/Button.stories.tsx
 PASS   browser: chromium  src/stories/Page.stories.tsx
 PASS   browser: chromium  src/stories/Counter.stories.tsx

Test Suites: 4 passed, 4 total
Tests:       9 passed, 9 total
Snapshots:   0 total
Time:        7.242 s
Ran all test suites related to changed files.

Watch Usage: Press w to show more.
```

### ãƒ†ã‚¹ãƒˆã‚’å¤±æ•—ã•ã›ã‚‹

ä¾‹ãˆã°ã“ã“ã§`Button`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚¯ãƒªãƒƒã‚¯ã§ããªã„çŠ¶æ…‹ã«ãªã£ãŸã¨ã™ã‚‹ã€‚ç¾å®Ÿçš„ã«ã¯è€ƒãˆã«ãã„ã‚±ãƒ¼ã‚¹ã ã‘ã©ã‚‚ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã‚±ãƒ¼ã‚¹ã¨ã—ã¦ã€‚

```diff:Button.tsx
    <button
      type="button"
      className={['storybook-button', `storybook-button--${size}`, mode].join(
        ' '
      )}
-      style={{ backgroundColor }}
+      style={{ backgroundColor, pointerEvents: 'none' }}
```

ä¿®æ­£ã‚’åŠ ãˆãŸ`Button`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®Storyè‡ªä½“ã¯ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ãªã„ã—Storybookã§ã‚‚è¡¨ç¤ºã ã‘è¦‹ã‚Œã°ç‰¹ã«å•é¡Œã¯è¦‹å½“ãŸã‚‰ãªã„ï¼ˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ããªã„ã“ã¨ã«é–‹ç™ºè€…ãŒç¢ºèªã—ã¦ã„ã¦æ°—ã¥ã‹ãªã„ã¨ã¯è€ƒãˆã«ãã„ãŒã“ã“ã§ã¯è€ƒæ…®ã—ãªã„ï¼‰ã‘ã©ã€`Counter`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã™ã‚‹ã€‚`Counter`ã®Storyã®ç”»é¢ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹ã¨ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/d45e49865cd3-20220529.png)

ä¸€æ–¹ã§`@storybook/test-runner`ã®æ–¹ã§ã¯ãƒ†ã‚¹ãƒˆã«æ™‚é–“ãŒè‹¥å¹²ã‹ã‹ã‚‹ã‚‚ã®ã®`Counter`ã®Storyã‚’ç‰¹ã«ç¢ºèªã›ãšã¨ã‚‚ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã™ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ï¼ˆStorybookãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”¨æ„ã—ã¦ã„ã‚‹`Page`ã®Storyã®ãƒ†ã‚¹ãƒˆã‚‚`Button`ã®ã‚¯ãƒªãƒƒã‚¯ä¸å¯ã«ãªã£ãŸå½±éŸ¿ã‚’å—ã‘ã¦å¤±æ•—ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã¯è€ƒæ…®ãŒæ¼ã‚Œã¦ã„ãŸï¼‰ã€‚

```sh
 PASS   browser: chromium  src/stories/Header.stories.tsx
 FAIL   browser: chromium  src/stories/Counter.stories.tsx
  â— Counter â€º Default â€º play-test

    page.evaluate: StorybookTestRunnerError:
    An error occurred in the following story. Access the link for full output:
    http://localhost:6006/?path=/story/counter--default&addonPanel=storybook/interactions/panel

    Message:
     unable to click element as it has or inherits pointer-events set to "none".

      at Object.<anonymous> (<anonymous>:82:13)
      at http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-QQ3TMKM5.js?v=26268201:212:14
          at Array.forEach (<anonymous>)
      at Channel2.handleEvent (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-QQ3TMKM5.js?v=26268201:211:19)
      at handler2 (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-QQ3TMKM5.js?v=26268201:141:16)
      at Channel2.emit (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-QQ3TMKM5.js?v=26268201:146:9)
      at PreviewWeb2.renderException (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-HTWPY52G.js?v=26268201:2823:20)
      at Object.showException (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-HTWPY52G.js?v=26268201:2782:25)
      at StoryRender2._callee9$ (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-HTWPY52G.js?v=26268201:424:32)
      at tryCatch (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-7K2HGKM4.js?v=26268201:45:44)
      at testFn (src/stories/Counter.stories.tsx:35:37)
      at Object.<anonymous> (src/stories/Counter.stories.tsx:50:17)

 PASS   browser: chromium  src/stories/Button.stories.tsx
 FAIL   browser: chromium  src/stories/Page.stories.tsx
  â— Example/Page â€º LoggedIn â€º play-test

    page.evaluate: StorybookTestRunnerError:
    An error occurred in the following story. Access the link for full output:
    http://localhost:6006/?path=/story/example-page--logged-in&addonPanel=storybook/interactions/panel

    Message:
     unable to click element as it has or inherits pointer-events set to "none".

      at Object.<anonymous> (<anonymous>:82:13)
      at http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-QQ3TMKM5.js?v=26268201:212:14
          at Array.forEach (<anonymous>)
      at Channel2.handleEvent (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-QQ3TMKM5.js?v=26268201:211:19)
      at handler2 (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-QQ3TMKM5.js?v=26268201:141:16)
      at Channel2.emit (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-QQ3TMKM5.js?v=26268201:146:9)
      at PreviewWeb2.renderException (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-HTWPY52G.js?v=26268201:2823:20)
      at Object.showException (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-HTWPY52G.js?v=26268201:2782:25)
      at StoryRender2._callee9$ (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-HTWPY52G.js?v=26268201:424:32)
      at tryCatch (http:/localhost:6006/node_modules/.vite-storybook/deps/chunk-7K2HGKM4.js?v=26268201:45:44)
      at testFn (src/stories/Page.stories.tsx:84:37)
      at Object.<anonymous> (src/stories/Page.stories.tsx:99:17)

Test Suites: 2 failed, 2 passed, 4 total
Tests:       2 failed, 7 passed, 9 total
Snapshots:   0 total
Time:        4.895 s, estimated 5 s
Ran all test suites related to changed files.

Watch Usage: Press w to show more.
```

ç¾å®Ÿçš„ã«ã¯ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®Storyã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚‚ã£ã¨å¤šãã‚ã‚‹ã¨æ€ã†ã®ã§ã€å®Ÿè¡Œæ™‚é–“ã‚’è€ƒãˆã‚‹ã¨ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãªãŒã‚‰ã¨ã„ã†ã®ã¯ã‚„ã‚‰ãªã„ã®ã§ã¯ãªã„ã‹ãªã¨æ€ã†ã€‚å®Ÿè¡Œæ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹ã®ã«ãƒ†ã‚¹ãƒˆå¯¾è±¡ã«ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‹ã‘ã‚‰ã‚ŒãŸã‚Šã™ã‚‹ã‘ã©ã‚‚å•é¡Œã®æ¤œçŸ¥ã¨ã„ã†æ„å‘³ã§ã¯ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚’çµã‚‰ãªã„æ–¹ãŒæœ›ã¾ã—ã„ã¯ãšã€‚ãŸã ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚CIã§ã‚‚ã“ã®ã‚ˆã†ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã§ãã‚‹ã“ã¨ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã§ã®å•é¡Œã‚’æ—©æœŸã«ç™ºè¦‹ã™ã‚‹æ‰‹åŠ©ã‘ã«ãªã‚‹ã¨æ€ã†ã€‚

## jest + [`@testing-library/react`](https://testing-library.com/docs/react-testing-library/intro/) + [`@testing-library/jest-dom`](https://testing-library.com/docs/ecosystem-jest-dom)

Reactã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã€æã‚‰ãç¾çŠ¶æœ€ã‚‚ä¸€èˆ¬çš„ã«ãªã£ã¦ã„ã‚‹ã®ã¯jestã‚’ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã¨ã—ã¦`@testing-library/react`ã¨`@testing-library/jest-dom`ã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã™ã‚‹å½¢ã§ã¯ãªã„ã‹ã¨æ€ã†ã‘ã©ã€Storybookã®ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆã¨ã¯ã©ã®ã‚ˆã†ã«é•ã„ãŒã‚ã‚‹ã®ã‹ã€‚
jestã¨[jsdom](https://github.com/jsdom/jsdom)ã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ãŸã‚‚ã®ã§å®Ÿéš›ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å®Œå…¨ã«å†ç¾ã§ãã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã¨ã„ã†ã®ãŒã‚ã‚Šã€ãã®ãŸã‚ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«é–¢ã‚ã‚‹ãƒ†ã‚¹ãƒˆãªã©ã¯å®Ÿæ–½ã§ããªã„ã‘ã©ã€`@storybook/test-runner`ã¯æœ¬ç‰©ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã®ã§ãã®ã‚ˆã†ãªåˆ¶é™ã‚’å—ã‘ãªã„ã“ã¨ãŒé•ã„ã¨ã—ã¦ã¯ã‚ã‚‹ã¨æ€ã†ã€‚
ä»¥ä¸‹ã®discussionã§ã¯ã€å®Ÿè¡Œé€Ÿåº¦ãŒåˆ¤æ–­è»¸ã«ãªã‚‹ã»ã©å¤§ããªå·®ãŒå‡ºãªã„ã“ã¨ã‚„Storybookã‚’ç”¨æ„ã™ã‚‹å¿…è¦ã®æœ‰ç„¡ã®é•ã„ãªã©ã«ã¤ã„ã¦ã‚‚è§¦ã‚Œã¦ã„ã‚‹ã€‚
https://github.com/storybookjs/storybook/discussions/16861#discussioncomment-2513340


## Chromaticã¨ã®ä½¿ã„åˆ†ã‘

https://www.chromatic.com/

Storybookã®é–‹ç™ºãƒãƒ¼ãƒ ã«ã‚ˆã£ã¦ä½œã‚‰ã‚Œã¦ã„ã‚‹ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ†ã‚¹ãƒˆã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ChromaticãŒã‚ã‚‹ã‘ã©ã‚‚ã€`@storybook/test-runner`ã¨Chromaticã¨ã®ä½¿ã„åˆ†ã‘ã¯ã©ã®ã‚ˆã†ã«è€ƒãˆã‚Œã°è‰¯ã„ã®ã‹ã€‚
Chromaticã§ã¯[UIãƒ†ã‚¹ãƒˆ](https://www.chromatic.com/docs/test)ã§æ­£å¸¸ã«StoryãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ãã¦ã„ã‚‹ã‹ã¯ç¢ºèªã§ãã‚‹ã¨æ€ã†ã—ã€[ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ](https://www.chromatic.com/docs/interactions)ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã€‚
Storybookã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¨CIã§ã®ä½¿ã„åˆ†ã‘ã€ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«åŠã³ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã¨ãã®ä»–ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆï¼ˆã“ã‚ŒãŒã©ã®ã‚ˆã†ãªã‚‚ã®ã‹ã¯ã¡ã‚‡ã£ã¨åˆ†ã‹ã‚‰ãªã„ï¼‰ã«ã‚ˆã‚‹ä½¿ã„åˆ†ã‘ã®è¨€åŠãŒã‚ã‚‹ã€‚

> - Use it locally and Chromatic on your CI.
> - Use Chromatic for visual and interaction tests and run other custom tests using the test runner.
>
> https://storybook.js.org/docs/react/writing-tests/test-runner#whats-the-difference-between-chromatic-and-test-runner

`@storybook/test-runner`ã§Chromaticã«ãŠã‘ã‚‹snapshotã§ã®è¦–è¦šçš„ãªæ¯”è¼ƒã§ã®ãƒ†ã‚¹ãƒˆãŒè¡Œãˆã‚‹ã‚ã‘ã§ã¯ãªã„ã¨ã„ã†ã®ã¯æ˜ç¢ºãªé•ã„ã¨ã—ã¦ã‚ã‚‹ã¨æ€ã†ã€‚

[Chromaticã¯Snapshotã®å®Ÿè¡Œå›æ•°ãŒå¢—åŠ ã™ã‚‹ã¨é‡‘éŠ­çš„ãªã‚³ã‚¹ãƒˆã‚’æ”¯æ‰•ã†å¿…è¦æ€§ãŒå‡ºã¦ãã‚‹](https://www.chromatic.com/pricing)ã¨æ€ã†ã®ã§ã€ãªã‚‹ã¹ããŠé‡‘ã‚’ã‹ã‘ãšã«ã¨ã„ã†ç‚¹ã§ã‚‚ä½¿ã„åˆ†ã‘ã®åˆ¤æ–­ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚
CIä¸Šã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã«ã¯CIã‚µãƒ¼ãƒ“ã‚¹ã§ã®é‡‘éŠ­é¢ã§ã®ã‚³ã‚¹ãƒˆã®å´é¢ã‚‚è€ƒãˆã‚‹å¿…è¦ã¯ã‚ã‚Šãã†ã ã‘ã©ã€ãã‚Œã¯Chromaticã§ã‚‚`@storybook/test-runner`ã§ã‚‚å¤§ããªé•ã„ã¯ãªã•ãã†ã€‚

## ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆé–¢é€£ãƒ„ãƒ¼ãƒ«

[Cypress](https://www.cypress.io/)ã‚„Playwrightã®ã‚ˆã†ãªE2Eãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆãŒæ©Ÿèƒ½ã¨ã—ã¦å«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã‚Šã—ã¦ã„ã¦ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æœ¬ç‰©ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ†ã‚¹ãƒˆã™ã‚‹é¸æŠè‚¢ãŒå¢—ãˆå§‹ã‚ã¦ã„ã‚‹ã‚ˆã†ã«æ€ã†ã€‚

https://docs.cypress.io/guides/component-testing/introduction

https://playwright.dev/docs/test-components

ä¸€æ–¹ã§å¾“æ¥ã®testing-library + jestã®ãƒ†ã‚¹ãƒˆã§ã‚ã£ã¦ã‚‚æœ¬ç‰©ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å‹•ã‹ã—ãªãŒã‚‰ç¢ºèªã§ãã‚‹[jest-preview](https://www.jest-preview.com/)ã®ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã‚‚ç™»å ´ã—ã¦ãã¦ã„ã‚‹ã€‚
https://www.jest-preview.com/docs/getting-started/intro


## ã•ã„ã”ã«

`@storybook/test-runner`ã¯ã¾ã ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦é–“ã‚‚ãªã„ã®ã§å®Ÿéš›ã«ä½¿ã£ã¦ã„ãã¨æã‚‰ãä¸å…·åˆãªã©ã«é­é‡ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã¨æ€ã†ã‘ã©ã€æã‚‰ãä»Šå¾ŒStorybookåˆ©ç”¨ã—ã¦ã„ã‚‹çŠ¶æ³ä¸‹ã§ã¯ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã¨ã—ã¦æœ‰åŠ›ãªé¸æŠè‚¢ã«ãªã‚‹ã®ã§ã¯ãªã„ã‹ãªã¨æ€ã†ã€‚
ãŸã ã€æœ¬ç‰©ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã§ãã‚‹ã‚‚ã®ã®UIã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆã¨ã„ã†æ„å‘³ã§ã‚«ãƒãƒ¼ã—ã¦ã„ã‚‹ç¯„å›²ãŒé™å®šçš„ã§ã¯ã‚ã‚‹ã¨æ€ã†ã®ã§ã€Chromaticãªã©ä»–ã®ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã¨ã®çµ„ã¿åˆã‚ã›ã§ä¿¡é ¼æ€§ã‚’ã©ã®ã‚ˆã†ã«é«˜ã‚ã‚‹ã‹ã¯å½“ç„¶è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
ä¸€æ–¹ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆé–¢é€£ã®ãƒ„ãƒ¼ãƒ«ã«é–¢ã—ã¦ã¯ä¸Šè¨˜ã®ã‚ˆã†ã«é¸æŠè‚¢ãŒå¢—ãˆã¦ããŸã‚Šã—ã¦ã„ã‚‹çŠ¶æ³ã«ã‚ã‚‹ã¨æ€ã†ã®ã§ã€ãã®è¾ºã‚Šã«ã¤ã„ã¦ã‚‚å‹•å‘ã‚’æ³¨è¦–ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠããŸã„ã€‚

