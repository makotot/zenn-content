---
title: 'Chromaticã®TurboSnapã¨ã¯ä½•ãªã®ã‹'
emoji: 'ðŸŽƒ'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['chromatic', 'storybook']
published: true
---

[Chromatic](https://www.chromatic.com/)ã§ã¯ãã®å¥‘ç´„ãƒ—ãƒ©ãƒ³ã‚„è«‹æ±‚é‡‘é¡ãŒ snapshot ã®å®Ÿè¡Œå›žæ•°ã«ã‚ˆã£ã¦å¤‰ã‚ã‚Šã€snapshot ã®å®Ÿè¡Œå›žæ•°ã¯[ãã®å¯¾è±¡ã® Story ã¨ãƒ“ãƒ«ãƒ‰å›žæ•°ã€ãƒ–ãƒ©ã‚¦ã‚¶ã€viewport ã®æŽ›ã‘åˆã‚ã›ã¨ãªã‚‹](https://www.chromatic.com/docs/billing#snapshots)ï¼ˆã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ—ãƒ©ãƒ³ã¯ä¾‹å¤–ï¼‰ã€‚\
ãã®ãŸã‚ snapshot ã®å®Ÿè¡Œå›žæ•°ã‚’ãªã‚‹ã¹ãæŠ‘æ­¢ã™ã‚‹ã“ã¨ã§é‡‘éŠ­çš„ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šãã†ã ã‘ã©ã€snapshot ã®å®Ÿè¡Œå›žæ•°ã‚’æŠ‘æ­¢ã™ã‚‹æ‰‹æ®µã¨ã—ã¦[TurboSnap](https://www.chromatic.com/docs/turbosnap)ã¨ã„ã†æ©Ÿèƒ½ãŒå­˜åœ¨ã™ã‚‹ã€‚

ã“ã“ã§ã¯ TurboSnap ãŒå…·ä½“çš„ã«ã©ã®ã‚ˆã†ãªæ©Ÿèƒ½ãªã®ã‹ã‚’[Chromatic å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.chromatic.com/docs/turbosnap)ã‚’èª­ã¿ã€å®Ÿéš›ã« Github Actions ã§æœ‰åŠ¹åŒ–ã—ã¦ã¿ã¦ã€ç¢ºèªã—ã¦ã¿ã‚‹ã€‚

## TurboSnap ã¨ã¯

https://www.chromatic.com/docs/turbosnap

TurboSnap ã¨ã¯ã€å¤‰æ›´å¯¾è±¡ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç‰¹å®šã—ã¦ãã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«é–¢é€£ã™ã‚‹ Story ã®ã¿ãƒ“ãƒ«ãƒ‰ãŠã‚ˆã³ snapshot ã®å¯¾è±¡ã¨ã™ã‚‹ Chromatic ã®æ©Ÿèƒ½ã§ã€ä¸Šè¿°ã®é€šã‚Š snapshot ã®å®Ÿè¡Œå›žæ•°æŠ‘æ­¢ã‚„ãã‚Œã«ä¼´ã†ãƒ“ãƒ«ãƒ‰é€Ÿåº¦æ”¹å–„ãŒè¦‹è¾¼ã‚ã‚‹ã‚‚ã®ã€‚

## å‰ææ¡ä»¶

TurboSnap ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€å‰æã¨ã—ã¦ä»¥ä¸‹ã‚’æº€ãŸã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚

- [Chromatic](https://github.com/chromaui/chromatic-cli) v5.8 ä»¥ä¸Š
- [Storybook](https://github.com/storybookjs/storybook) v6.2 ä»¥ä¸Š
- Webpackï¼ˆVite ã®æ–¹ã®ã‚µãƒãƒ¼ãƒˆã¯å®Ÿé¨“çš„ã§ [vite-plugin-turbosnap](https://github.com/IanVS/vite-plugin-turbosnap) ã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ï¼‰
- `.storybook/main.js`ã§å¯¾è±¡ã® story ãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã‚‹
- squash ã‚„ rebase ã§ã® merge ã§ã¯ãªã„
- `pull_request`ã§ã¯ãªã`push`ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã—ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹ï¼ˆGithub Actions ã®å ´åˆï¼‰

squash ã‚„ rebase ã—ãªã„ã“ã¨ã‚„ Github Actions ã§`push`ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã™ã‚‹ã“ã¨ã¯ã€Chromatic ã®[Baseline](https://www.chromatic.com/docs/branching-and-baselines#baselines)ã‚’ä¿ã¤ã“ã¨ã«é–¢é€£ã—ãŸã‚‚ã®ã ã¨æ€ã‚ã‚Œã‚‹ã®ã§ã€TurboSnap ã®æœ‰åŠ¹ç„¡åŠ¹ã«é–¢ã‚ã‚‰ãš Chromatic ã‚’åˆ©ç”¨ã™ã‚‹ä¸Šã§ã¯å¾“ã£ã¦ãŠã„ãŸæ–¹ãŒè‰¯ã•ãã†ãªé …ç›®ã«è¦‹ãˆã‚‹ã€‚

## æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯

`--only-changed`ã‚’ CLI ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ¸¡ã™ã‹ã€ï¼ˆGithub Actions ã®å ´åˆï¼‰`onlyChanged`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§æœ‰åŠ¹ã«ãªã‚‹ã€‚

## ã©ã®ã‚ˆã†ã«ã—ã¦æ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹

å†…éƒ¨çš„ã«ã¯ä»¥ä¸‹ã®æµã‚Œã§å‡¦ç†ã•ã‚Œã¦ã„ã‚‹ã€‚Vite ã®å ´åˆã¯[vite-plugin-turbosnap ãŒå¤‰æ›´å¯¾è±¡ã® story ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡ºéƒ¨åˆ†ã‚’æ‹…ã£ã¦ã„ã‚‹](https://github.com/IanVS/vite-plugin-turbosnap#how-it-works)ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚

1. æ¯”è¼ƒå¯¾è±¡ã®ãƒ“ãƒ«ãƒ‰ã® commit ã¨ã®å·®åˆ†ã«ã¤ã„ã¦ç¢ºèªã™ã‚‹
2. Webpack ã® [dependency graph](https://webpack.js.org/concepts/dependency-graph/) ã‚’ç”¨ã„ã¦ã€å·®åˆ†ã‚’å…ƒã«å¤‰æ›´å¯¾è±¡ã® story ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŽ¢ã™
3. å¯¾è±¡ã® Story ãƒ•ã‚¡ã‚¤ãƒ«ã® story ã®ã¿ã‚’ snapshot å®Ÿè¡Œã™ã‚‹

### TurboSnap ãŒæœ‰åŠ¹ã§ã‚‚å…¨ã¦ã® Story ãŒ snapshot ã®å¯¾è±¡ã«ãªã‚‹ã‚±ãƒ¼ã‚¹

å½é™½æ€§å›žé¿ã®ãŸã‚ã€ç‰¹å®šã®çŠ¶æ³ã«ãŠã„ã¦ã¯å…¨ã¦ã® Story ãŒ snapshot å¯¾è±¡ã¨ãªã‚‹ã€‚ãã®çŠ¶æ³ã¨ã¯ä»¥ä¸‹ã®çŠ¶æ³ã€‚

- `package.json`, `package-lock.json`ï¼ˆã‚‚ã—ãã¯`yarn.lock`ï¼‰ã§ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å¤‰æ›´
- Storybook ã®è¨­å®šã®å¤‰æ›´
- `.storybook/preview.js`ã§ import ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã™ã‚‹å¤‰æ›´
- `--externals`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã™ã‚‹å¤‰æ›´
- åŒä¸€ãƒ“ãƒ«ãƒ‰ã®å†å®Ÿè¡Œ
- [ã‚¤ãƒ³ãƒ•ãƒ©ã®æ›´æ–°](https://www.chromatic.com/docs/infrastructure-upgrades)
- æ–°ã—ã„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã® UI ãƒ†ã‚¹ãƒˆ

ãªãŠã€è¿½åŠ ã§è¨­å®šãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹ï¼ˆ`--storybook-build-dir`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã„ã‚‹å ´åˆã‚„ Storybook ã§`staticDirs`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã„ã‚‹å ´åˆãªã©ãŒãã‚Œã«è©²å½“ã™ã‚‹ï¼‰ã‚‚ã‚ã‚‹ã‚ˆã†ã ã‘ã©ã€ã“ã“ã§ã¯è©³ç´°ã«ç¢ºèªã—ãªã„ã€‚

## Github Actions ã§ç¢ºèªã™ã‚‹

TurboSnap ãŒæ„å›³é€šã‚Šã«å‹•ã„ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ CLI ã®å‡ºåŠ›ã‚’ç¢ºèªã™ã‚‹ã€‚\
ä»¥ä¸‹ã®ã‚ˆã†ã« Chromatic ã® Github Actions ã§`onlyChanged`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦æŒ™å‹•ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã€‚

```yml
# Workflow name
name: 'Chromatic'

# Event for the workflow
on: push

# List of jobs
jobs:
  chromatic-deployment:
    # Operating System
    runs-on: ubuntu-latest
    # Job steps
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # ðŸ‘ˆ Required to retrieve git history
      - name: Install dependencies
        run: npm ci
        # ðŸ‘‡ Adds Chromatic as a step in the workflow
      - name: Publish to Chromatic
        uses: chromaui/action@v1
        # Chromatic GitHub Action options
        with:
          # ðŸ‘‡ Chromatic projectToken, refer to the manage page to obtain it.
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          autoAcceptChanges: 'main'
          onlyChanged: true
```

ã“ã®çŠ¶æ…‹ã§ä¸€éƒ¨ã® Story ã®ã¿ã«å½±éŸ¿ãŒã‚ã‚‹ï¼ˆãã® Story ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«é–‰ã˜ãŸ CSS ã®ä¿®æ­£ç­‰ï¼‰ã‚’åŠ ãˆãŸ commit ã‚’ push ã—ã¦ Github Actions ã§ Chromatic ã®å‡ºåŠ›ã‚’ç¢ºèªã™ã‚‹ã€‚ãã†ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã« TurboSnap ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¦ã€å½±éŸ¿ãŒã‚ã‚‹ Story ã«é™å®šã—ã¦ snapshot ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã€‚

```
Starting partial build
    â†’ Snapshots will be limited to 1 story files affected by recent changes
âœ” TurboSnap enabled
Capturing 2 snapshots and skipping 6 snapshots.
```

## ã¾ã¨ã‚

TurboSnap ã¯è¨­å®šãŒè¤‡é›‘åŒ–ã™ã‚‹ã“ã¨ã«ã‚ˆã‚‹ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§ãŒä½Žä¸‹ã™ã‚‹æ‡¸å¿µãªã©ã‹ã‚‰ã€Chromatic ã‚’ã‚ã‚‹ç¨‹åº¦ä½¿ã„æ…£ã‚ŒãŸçŠ¶æ…‹ã«ãªã£ã¦ã‹ã‚‰åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒæŽ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®ç‚¹ã‚’è€ƒæ…®ã—ã¤ã¤ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆã‚‹ä¸Šã§ã®æ‰‹æ®µã¨ã—ã¦ã¯æœ‰åŠ›ãªé¸æŠžè‚¢ã¨ã—ã¦èªè­˜ã—ã¦ãŠãã¨è‰¯ã•ãã†ã€‚

> âš ï¸ When using TurboSnap, your builds may complete in less time using fewer snapshots. However, we donâ€™t recommend using TurboSnap immediately when starting out with Chromatic since the configuration is more complicated and can lead to difficult to debug scenarios or UI changes being missed. Instead, become familiar with Chromaticâ€™s out of the box behavior and once your project has been running smoothly for some time consider trying out TurboSnap.\
> https://www.chromatic.com/docs/turbosnap
