---
title: "Node.jsにおけるCommonJS or ES moduleの判別について"
emoji: "📌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nodejs"]
published: false
---

## Node.jsではどのようにモジュールの種別を判定するか

ES moduleとして扱うときはどのようなケースか。

- 拡張子が`.mjs`
- 拡張子が`.js`で、最も近い`package.json`の`type`が`module`
- `node index.js --input-type=module`がオプションとして渡されたとき

上記以外のケースでは後方互換性を考慮して全てCommonJSとして扱う。明示的なものだと以下のようなものが該当する。

- 拡張子が`.cjs`
- 拡張子が`.js`で、最も近い`package.json`の`type`が`commonjs`
- `node index.js --input-type=commonjs`がオプションとして渡されたとき

https://nodejs.org/docs/latest-v16.x/api/packages.html#determining-module-system

## `type`フィールド

- `package.json`に`type`フィールドがある場合、その`package.json`が同じディレクトリか最も近い上位ディレクトリとなる`.js`ファイルのモジュール形式を決定するものになる
  - `type`フィールドが`module`
    - `.js`の拡張子のファイルはESModuleとして扱われる
- `package.json`は、現在のディレクトリ（その`.js`ファイルがあるディレクトリ）を起点にしてその1つ上の階層のディレクトリを探し続ける
  - 探す中で最初に見つかった`package.json`の`type`フィールドを見る
  - 見つかった`package.json`に`type`フィールドが存在しない、もしくは`commonjs`の場合、CommonJSとして扱う
  - `package.json`が見つからなかった場合、CommonJSとして扱う
- `import './foo.js'`で読み込むとき、最も近い`package.json`の`type`が`module`であればそれはES moduleとして扱われる
- `type`フィールドに関わらず拡張子が`.mjs`はES moduleで扱われ、`.cjs`はCommonJS扱いになる

https://nodejs.org/docs/latest-v16.x/api/packages.html#type

## Webpack

モジュールの取り扱いは

- 拡張子が`.mjs`、もしくは拡張子が`.js`で`package.json`の`type`フィールドが`module`
  - CommonJSは利用できない
  - `import`するファイルの拡張子は省略できない
    - [`resolve.fullySpecified`](https://webpack.js.org/configuration/module/#resolvefullyspecified)を`false`で指定すれば省略可能に変更できる
- 拡張子が`.cjs`、もしくは拡張子が`.js`で`package.json`の`type`が`commonjs`
  - ES moduleは利用できない

v2からはES6のモジュールのシンタックスがサポートされていてデフォルトで`ipmort`, `export`が利用できる（ES6全般が使えるわけではない）

https://webpack.js.org/api/module-methods/

---

- https://transitivebullsh.it/javascript-dev-tools-in-2022#b080a09cb46d45aaaa4e64b3edb7652f
- https://bundlers.tooling.report/importing-modules/
- https://github.com/sindresorhus/meta/discussions/15
- https://github.com/mgechev/is-esm
- https://numb86-tech.hatenablog.com/entry/2020/08/07/091142
