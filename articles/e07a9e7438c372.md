---
title: "Node.jsにおけるCommonJS or ES moduleの判別について"
emoji: "📌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nodejs"]
published: false
---

## Node.jsではどのようにモジュールの種別を判定するか

ES moduleとして扱うときはどのようなケースか。

- 拡張子が`.mjs`
- 拡張子が`.js`で、最も近い`package.json`の`type`が`module`
- `--input-type=module`がオプションとして渡されたとき

上記以外のケースでは後方互換性を考慮して全てCommonJSとして扱う。明示的なものだと以下のようなものが該当する。

- 拡張子が`.cjs`
- 拡張子が`.js`で、最も近い`package.json`の`type`が`commonjs`
- `--input-type=commonjs`がオプションとして渡されたとき


https://nodejs.org/docs/latest-v16.x/api/packages.html#determining-module-system

## `type`フィールド

- `package.json`に`type`フィールドがある場合、その`package.json`が同じディレクトリか最も近い上位ディレクトリとなる`.js`ファイルのモジュール形式を決定するものになる
  - `type`フィールドが`module`
    - `.js`の拡張子のファイルはESModuleとして扱われる
- `package.json`は、現在のディレクトリ（その`.js`ファイルがあるディレクトリ）を起点にしてその1つ上の階層のディレクトリを探し続ける（という理解でよい？）
  - 探す中で最初に見つかった`package.json`の`type`フィールドを見る


https://nodejs.org/docs/latest-v16.x/api/packages.html#type


---

- https://transitivebullsh.it/javascript-dev-tools-in-2022#b080a09cb46d45aaaa4e64b3edb7652f
- https://bundlers.tooling.report/importing-modules/
- https://webpack.js.org/guides/ecma-script-modules/#flagging-modules-as-esm
